# Browser Storage Mechanisms

Understanding how browsers store data internally: localStorage, sessionStorage, cookies, and IndexedDB.

---

## Core Concept

Browsers store client-side data in different ways, each with its own storage mechanism, location, and behavior. Understanding these internals helps optimize storage usage and debug issues.

---

## localStorage Storage Mechanism

### How Browsers Store localStorage

**Storage Location:**

- Stored in **browser's profile directory**
- Location varies by browser:
  - **Chrome:** `~/Library/Application Support/Google/Chrome/Default/Local Storage/`
  - **Firefox:** `~/Library/Application Support/Firefox/Profiles/[profile]/storage/default/`
  - **Safari:** `~/Library/Safari/LocalStorage/`

**Storage Format:**

- Stored as **SQLite database** (Chrome) or **JSON files** (Firefox)
- One database/file per origin
- Key-value pairs stored as strings

**Persistence:**

- ✅ Persists across browser sessions
- ✅ Persists across browser restarts
- ✅ Persists until user clears browser data
- ✅ Shared across all tabs/windows of same origin

---

### localStorage Quotas

**Storage Limits:**

- **Chrome:** ~10MB per origin
- **Firefox:** ~10MB per origin
- **Safari:** ~5MB per origin
- **Edge:** ~10MB per origin

**Quota Calculation:**

- Browser reserves ~50% of available disk space
- Each origin gets a share based on usage
- Can request more quota via Storage API

**Checking Quota:**

```javascript
navigator.storage.estimate().then((estimate) => {
  console.log("Quota:", estimate.quota);
  console.log("Usage:", estimate.usage);
  console.log("Available:", estimate.quota - estimate.usage);
});
```

---

### localStorage Eviction

**When localStorage is Cleared:**

1. User clears browser data
2. User clears site data
3. Browser runs out of storage (LRU eviction)
4. Origin exceeds quota

**Eviction Policy:**

- **LRU (Least Recently Used)** - Oldest/unused data cleared first
- Browser may clear entire origin's storage
- No partial eviction (all-or-nothing per origin)

---

## sessionStorage Storage Mechanism

### How Browsers Store sessionStorage

**Storage Location:**

- Stored in **memory** (RAM) or **temporary files**
- Not persisted to disk (except for crash recovery)
- One storage per tab/window

**Storage Format:**

- Similar to localStorage (SQLite or JSON)
- Isolated per tab/window
- Key-value pairs stored as strings

**Persistence:**

- ✅ Persists for tab session
- ❌ Cleared when tab closes
- ❌ Not shared across tabs
- ✅ Survives page refresh (same tab)

---

### sessionStorage Isolation

**Tab Isolation:**

- Each tab has its own sessionStorage
- Data in Tab 1 is not accessible in Tab 2
- Even for same origin

**Example:**

```javascript
// Tab 1
sessionStorage.setItem("data", "tab1");

// Tab 2 (same origin)
sessionStorage.setItem("data", "tab2");

// Each tab has its own value
console.log(sessionStorage.getItem("data")); // Different in each tab
```

---

## Cookie Storage Mechanism

### How Browsers Store Cookies

**Storage Location:**

- Stored in **browser's cookie database**
- Location varies by browser:
  - **Chrome:** `~/Library/Application Support/Google/Chrome/Default/Cookies`
  - **Firefox:** `~/Library/Application Support/Firefox/Profiles/[profile]/cookies.sqlite`
  - **Safari:** `~/Library/Cookies/`

**Storage Format:**

- Stored as **SQLite database**
- One database for all cookies
- Cookies stored with domain, path, expiration

**Persistence:**

- ✅ Persists until expiration
- ✅ Persists across browser sessions
- ✅ Sent with HTTP requests
- ✅ Server-accessible

---

### Cookie Scope

**Domain Scope:**

- Cookies are **domain-scoped**
- `domain=.example.com` → Available to all subdomains
- `domain=example.com` → Available only to exact domain

**Path Scope:**

- Cookies are **path-scoped**
- `path=/` → Available to all paths
- `path=/admin` → Available only to /admin and subpaths

**Same-Origin Policy:**

- Cookies follow same-origin policy
- Isolated by protocol, domain, and port

---

### Cookie Limits

**Size Limit:**

- **~4KB per cookie** (including name, value, attributes)
- Browsers may reject larger cookies

**Number Limit:**

- **~20-50 cookies per domain** (varies by browser)
- Browsers may reject additional cookies

**Total Limit:**

- **~4KB total per domain** (some browsers)
- Older browsers had stricter limits

---

## IndexedDB Storage Mechanism

### How Browsers Store IndexedDB

**Storage Location:**

- Stored in **browser's IndexedDB directory**
- Location varies by browser:
  - **Chrome:** `~/Library/Application Support/Google/Chrome/Default/IndexedDB/`
  - **Firefox:** `~/Library/Application Support/Firefox/Profiles/[profile]/storage/default/`
  - **Safari:** `~/Library/Safari/IndexedDB/`

**Storage Format:**

- Stored as **LevelDB** (Chrome) or **SQLite** (Firefox)
- One database per origin
- Structured data with indexes

**Persistence:**

- ✅ Persists across browser sessions
- ✅ Persists until user clears browser data
- ✅ Can store large amounts of data

---

### IndexedDB Quotas

**Storage Limits:**

- **~50% of available disk space** (shared across all origins)
- Browser calculates quota dynamically
- Can request more quota via Storage API

**Quota Calculation:**

- Based on available disk space
- Shared pool for all origins
- Browser may reduce quota if disk is full

---

## Storage Events and Synchronization

### Storage Events

**When Storage Events Fire:**

- When localStorage/sessionStorage changes in **other tabs/windows**
- Does **not** fire in the tab that made the change

**Storage Event Properties:**

- `key` - Changed key
- `oldValue` - Previous value
- `newValue` - New value
- `storageArea` - localStorage or sessionStorage
- `url` - URL of the page that made the change

**Example:**

```javascript
// Tab 1: Set value
localStorage.setItem("message", "Hello");

// Tab 2: Receives event
window.addEventListener("storage", (event) => {
  console.log("Key:", event.key); // 'message'
  console.log("New value:", event.newValue); // 'Hello'
});
```

---

### Storage Synchronization

**localStorage:**

- ✅ Synchronized across tabs/windows (same origin)
- ✅ Changes visible immediately in other tabs
- ✅ Storage events fire in other tabs

**sessionStorage:**

- ❌ Not synchronized (tab-isolated)
- ❌ Changes not visible in other tabs
- ❌ No storage events

**Cookies:**

- ✅ Synchronized across tabs/windows
- ✅ Changes visible immediately
- ✅ Sent with HTTP requests

**IndexedDB:**

- ✅ Synchronized across tabs/windows (same origin)
- ✅ Changes visible in other tabs
- ✅ No built-in events (must implement manually)

---

## Security and Isolation

### Same-Origin Policy

**All storage follows same-origin policy:**

- Isolated by **protocol** (http vs https)
- Isolated by **domain** (example.com vs other.com)
- Isolated by **port** (example.com:80 vs example.com:443)

**Example:**

```
http://example.com  ≠  https://example.com  (different protocol)
example.com        ≠  subdomain.example.com (different domain)
example.com:80     ≠  example.com:443      (different port)
```

---

### Storage Isolation

**localStorage:**

- Isolated per origin
- All scripts on same origin can access
- Not accessible from other origins

**sessionStorage:**

- Isolated per origin and tab
- All scripts on same origin and tab can access
- Not accessible from other origins or tabs

**Cookies:**

- Isolated per domain (can be shared across subdomains)
- Accessible to server and client scripts
- Can be restricted with HttpOnly, Secure, SameSite

**IndexedDB:**

- Isolated per origin
- All scripts on same origin can access
- Not accessible from other origins

---

## Storage Quotas and Eviction

### Quota Management

**How Browsers Calculate Quotas:**

1. Reserve ~50% of available disk space
2. Allocate quota to origins based on usage
3. Monitor disk usage
4. Reduce quotas if disk is full

**Requesting More Quota:**

```javascript
navigator.storage.persist().then((granted) => {
  if (granted) {
    console.log("Persistent storage granted");
  }
});
```

---

### Eviction Policies

**localStorage/sessionStorage:**

- **LRU (Least Recently Used)** eviction
- Entire origin's storage cleared (all-or-nothing)
- No partial eviction

**IndexedDB:**

- **LRU eviction** for entire database
- Browser may clear entire origin's IndexedDB
- No partial eviction

**Cookies:**

- **Expiration-based** eviction
- Oldest cookies cleared first if limit exceeded
- Partial eviction possible

---

## Common Questions

### Q: Where is localStorage actually stored?

**A:** In browser's profile directory as SQLite database (Chrome) or JSON files (Firefox).

### Q: Why is sessionStorage cleared when tab closes?

**A:** It's stored in memory/temporary files, not persisted to disk.

### Q: Can cookies be accessed from JavaScript?

**A:** Yes, unless they have `HttpOnly` flag (server-side only).

### Q: How does browser decide storage quotas?

**A:** Based on available disk space, typically ~50% reserved for browser storage.

### Q: What happens when storage quota is exceeded?

**A:** Browser throws `QuotaExceededError`. May evict old data using LRU.

---

## Related Topics

- [Storage APIs](<../../1.%20JavaScript/2.%20Javascript%20Runtime%20Environment%20(JRE)/1.%20BRE%20/2.%20WebAPIs/2.%20WebAPIs%20&%20Events/5.%20Storage%20APIs/index.md>) - API usage and comparisons
- [Browser Caching Mechanisms](./17.%20Browser%20Caching%20Mechanisms.md) - HTTP cache internals
- [Blob URLs and Memory Management](./14.%20Blob%20URLs%20and%20Memory%20Management.md) - Memory storage

---

## Summary

**Storage Locations:**

- **localStorage:** Browser profile directory (SQLite/JSON)
- **sessionStorage:** Memory/temporary files
- **Cookies:** Browser cookie database (SQLite)
- **IndexedDB:** Browser IndexedDB directory (LevelDB/SQLite)

**Persistence:**

- **localStorage/IndexedDB:** Until user clears browser data
- **sessionStorage:** Until tab closes
- **Cookies:** Until expiration

**Quotas:**

- **localStorage/sessionStorage:** ~5-10MB per origin
- **Cookies:** ~4KB per cookie, ~20-50 cookies per domain
- **IndexedDB:** ~50% of disk space (shared)

**Isolation:**

- All storage follows same-origin policy
- sessionStorage is additionally tab-isolated
- Cookies can be domain-scoped (subdomains)
