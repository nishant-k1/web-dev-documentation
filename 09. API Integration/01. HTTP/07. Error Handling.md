# Error Handling

How to handle HTTP errors in API integration - error response formats, retry strategies, and best practices.

---

## Core Concept

**Error handling** is crucial for robust API integration. HTTP errors can occur at different levels and need to be handled appropriately.

**Error Categories:**

1. **Network errors** - Connection failed, timeout
2. **HTTP errors** - 4xx, 5xx status codes
3. **Parsing errors** - Invalid JSON, malformed response
4. **Application errors** - Business logic errors

---

## HTTP Error Status Codes

### Client Errors (4xx)

**4xx errors** indicate the client made a mistake.

**Common 4xx Errors:**

- **400 Bad Request** - Invalid request data
- **401 Unauthorized** - Not authenticated
- **403 Forbidden** - Not authorized
- **404 Not Found** - Resource doesn't exist
- **422 Unprocessable Entity** - Validation errors
- **429 Too Many Requests** - Rate limit exceeded

---

### Server Errors (5xx)

**5xx errors** indicate server-side problems.

**Common 5xx Errors:**

- **500 Internal Server Error** - Server error
- **502 Bad Gateway** - Gateway error
- **503 Service Unavailable** - Server overloaded
- **504 Gateway Timeout** - Timeout waiting for upstream

---

## Error Response Formats

### Standard Error Format

**Recommended structure:**

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid email format",
    "details": {
      "email": "Must be a valid email address"
    },
    "timestamp": "2024-01-01T00:00:00Z",
    "path": "/api/users"
  }
}
```

---

### Common Error Formats

**Format 1: Simple**

```json
{
  "error": "Invalid email format"
}
```

**Format 2: Detailed**

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid email format",
    "fields": {
      "email": "Must be valid email"
    }
  }
}
```

**Format 3: Array Format**

```json
{
  "errors": [
    {
      "field": "email",
      "message": "Invalid email format"
    },
    {
      "field": "age",
      "message": "Age must be positive"
    }
  ]
}
```

---

## Error Handling Patterns

### Pattern 1: Basic Error Handling

```javascript
fetch("/api/users")
  .then((res) => {
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    return res.json();
  })
  .then((data) => {
    console.log(data);
  })
  .catch((error) => {
    console.error("Error:", error);
  });
```

---

### Pattern 2: Status Code Handling

```javascript
async function fetchUsers() {
  try {
    const res = await fetch("/api/users");

    if (res.status === 200) {
      return await res.json();
    } else if (res.status === 401) {
      // Redirect to login
      window.location.href = "/login";
      throw new Error("Unauthorized");
    } else if (res.status === 404) {
      throw new Error("Resource not found");
    } else if (res.status >= 500) {
      throw new Error("Server error");
    } else {
      const error = await res.json();
      throw new Error(error.message || "Request failed");
    }
  } catch (error) {
    console.error("Error:", error);
    throw error;
  }
}
```

---

### Pattern 3: Comprehensive Error Handler

```javascript
class APIError extends Error {
  constructor(status, message, details) {
    super(message);
    this.status = status;
    this.details = details;
    this.name = "APIError";
  }
}

async function handleResponse(response) {
  const contentType = response.headers.get("content-type");

  // Check if response is JSON
  if (!contentType || !contentType.includes("application/json")) {
    throw new APIError(response.status, "Invalid response format", null);
  }

  const data = await response.json();

  if (!response.ok) {
    throw new APIError(
      response.status,
      data.error?.message || data.message || "Request failed",
      data.error?.details || data.errors || null
    );
  }

  return data;
}

// Usage
fetch("/api/users")
  .then(handleResponse)
  .then((data) => console.log(data))
  .catch((error) => {
    if (error instanceof APIError) {
      console.error(`API Error ${error.status}:`, error.message);
      if (error.details) {
        console.error("Details:", error.details);
      }
    } else {
      console.error("Network error:", error);
    }
  });
```

---

## Handling Specific Errors

### 400 Bad Request

```javascript
fetch("/api/users", {
  method: "POST",
  body: JSON.stringify({ invalid: "data" }),
}).then((res) => {
  if (res.status === 400) {
    return res.json().then((error) => {
      // Show validation errors to user
      console.error("Validation errors:", error.errors);
      // Display errors in form
    });
  }
});
```

---

### 401 Unauthorized

```javascript
fetch("/api/users", {
  headers: {
    Authorization: "Bearer expired-token",
  },
}).then((res) => {
  if (res.status === 401) {
    // Clear stored token
    localStorage.removeItem("token");
    // Redirect to login
    window.location.href = "/login";
  }
});
```

---

### 403 Forbidden

```javascript
fetch("/api/admin/users").then((res) => {
  if (res.status === 403) {
    // Show "Access denied" message
    alert("You do not have permission to access this resource");
  }
});
```

---

### 404 Not Found

```javascript
fetch("/api/users/999").then((res) => {
  if (res.status === 404) {
    // Show "Not found" message
    console.error("User not found");
    // Display 404 page or message
  }
});
```

---

### 422 Unprocessable Entity

```javascript
fetch("/api/users", {
  method: "POST",
  body: JSON.stringify({ email: "invalid-email" }),
}).then((res) => {
  if (res.status === 422) {
    return res.json().then((error) => {
      // Show validation errors
      error.errors.forEach((err) => {
        console.error(`${err.field}: ${err.message}`);
        // Display error next to form field
      });
    });
  }
});
```

---

### 429 Too Many Requests

```javascript
fetch("/api/users").then((res) => {
  if (res.status === 429) {
    const retryAfter = res.headers.get("Retry-After");
    console.error(`Rate limit exceeded. Retry after ${retryAfter} seconds`);
    // Wait and retry
    setTimeout(() => {
      fetch("/api/users");
    }, retryAfter * 1000);
  }
});
```

---

### 500 Internal Server Error

```javascript
fetch("/api/users").then((res) => {
  if (res.status === 500) {
    // Log error for debugging
    console.error("Server error occurred");
    // Show user-friendly message
    alert("Something went wrong. Please try again later.");
    // Report to error tracking service
  }
});
```

---

### 503 Service Unavailable

```javascript
fetch("/api/users").then((res) => {
  if (res.status === 503) {
    // Show "Service unavailable" message
    console.error("Service temporarily unavailable");
    // Retry after delay
    setTimeout(() => {
      fetch("/api/users");
    }, 5000);
  }
});
```

---

## Retry Strategies

### Simple Retry

```javascript
async function fetchWithRetry(url, options = {}, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      const res = await fetch(url, options);
      if (res.ok) {
        return res;
      }
      // Retry on server errors
      if (res.status >= 500 && i < maxRetries - 1) {
        await new Promise((resolve) => setTimeout(resolve, 1000 * (i + 1)));
        continue;
      }
      throw new Error(`HTTP error! status: ${res.status}`);
    } catch (error) {
      if (i === maxRetries - 1) {
        throw error;
      }
      await new Promise((resolve) => setTimeout(resolve, 1000 * (i + 1)));
    }
  }
}
```

---

### Exponential Backoff

```javascript
async function fetchWithExponentialBackoff(url, options = {}, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      const res = await fetch(url, options);
      if (res.ok) {
        return res;
      }
      // Retry on server errors
      if (res.status >= 500 && i < maxRetries - 1) {
        const delay = Math.pow(2, i) * 1000; // 1s, 2s, 4s
        await new Promise((resolve) => setTimeout(resolve, delay));
        continue;
      }
      throw new Error(`HTTP error! status: ${res.status}`);
    } catch (error) {
      if (i === maxRetries - 1) {
        throw error;
      }
      const delay = Math.pow(2, i) * 1000;
      await new Promise((resolve) => setTimeout(resolve, delay));
    }
  }
}
```

---

## Network Error Handling

### Handling Network Errors

```javascript
fetch("/api/users")
  .then((res) => res.json())
  .catch((error) => {
    if (error.name === "TypeError" && error.message.includes("fetch")) {
      // Network error
      console.error("Network error - check your connection");
    } else if (error.name === "SyntaxError") {
      // JSON parsing error
      console.error("Invalid JSON response");
    } else {
      // Other error
      console.error("Error:", error);
    }
  });
```

---

### Timeout Handling

```javascript
function fetchWithTimeout(url, options = {}, timeout = 5000) {
  return Promise.race([
    fetch(url, options),
    new Promise((_, reject) =>
      setTimeout(() => reject(new Error("Request timeout")), timeout)
    ),
  ]);
}

// Usage
fetchWithTimeout("/api/users", {}, 5000)
  .then((res) => res.json())
  .catch((error) => {
    if (error.message === "Request timeout") {
      console.error("Request timed out");
    }
  });
```

---

## Error Handling Best Practices

### 1. Always Handle Errors

```javascript
// ❌ Bad - No error handling
fetch("/api/users")
  .then((res) => res.json())
  .then((data) => console.log(data));

// ✅ Good - Error handling
fetch("/api/users")
  .then((res) => {
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    return res.json();
  })
  .then((data) => console.log(data))
  .catch((error) => {
    console.error("Error:", error);
    // Show error to user
  });
```

---

### 2. Provide User-Friendly Messages

```javascript
function getUserFriendlyMessage(status) {
  switch (status) {
    case 400:
      return "Invalid request. Please check your input.";
    case 401:
      return "Please log in to continue.";
    case 403:
      return "You do not have permission to perform this action.";
    case 404:
      return "Resource not found.";
    case 500:
      return "Server error. Please try again later.";
    default:
      return "An error occurred. Please try again.";
  }
}
```

---

### 3. Log Errors for Debugging

```javascript
fetch("/api/users")
  .then(handleResponse)
  .catch((error) => {
    // Log for debugging
    console.error("API Error:", {
      message: error.message,
      status: error.status,
      timestamp: new Date().toISOString(),
      url: "/api/users",
    });

    // Show user-friendly message
    alert(getUserFriendlyMessage(error.status));
  });
```

---

### 4. Retry Transient Errors

```javascript
// Retry on server errors (5xx)
if (res.status >= 500) {
  // Retry with exponential backoff
}
```

---

## Error Handling in React

### Custom Hook

```javascript
function useAPI() {
  const [data, setData] = useState(null);
  const [error, setError] = useState(null);
  const [loading, setLoading] = useState(false);

  const fetchData = async (url, options = {}) => {
    setLoading(true);
    setError(null);

    try {
      const res = await fetch(url, options);

      if (!res.ok) {
        const errorData = await res.json();
        throw new APIError(res.status, errorData.message, errorData.errors);
      }

      const data = await res.json();
      setData(data);
    } catch (error) {
      setError(error);
    } finally {
      setLoading(false);
    }
  };

  return { data, error, loading, fetchData };
}

// Usage
function UsersList() {
  const { data, error, loading, fetchData } = useAPI();

  useEffect(() => {
    fetchData("/api/users");
  }, []);

  if (loading) return <div>Loading...</div>;
  if (error) return <div>Error: {error.message}</div>;
  return <div>{/* Render data */}</div>;
}
```

---

## Common Questions

### Q: Should I retry all errors?

**A:** No. Only retry:

- Network errors
- 5xx server errors
- 429 Too Many Requests (with delay)

Don't retry 4xx errors (client errors).

### Q: How many times should I retry?

**A:** Typically 3 times with exponential backoff. Don't retry indefinitely.

### Q: Should I show technical error messages to users?

**A:** No. Show user-friendly messages. Log technical details for debugging.

---

## Related Topics

- [HTTP Status Codes](./03.%20HTTP%20Status%20Codes.md) - Understanding status codes
- [HTTP Methods](./02.%20HTTP%20Methods.md) - Error handling for each method
- [REST API Principles](./06.%20REST%20API%20Principles.md) - Error formats in REST
- [HTTP Clients](./13.%20HTTP%20Clients.md) - Error handling with different clients

---

## Summary

**Error Categories:**

- **Network errors** - Connection failed, timeout
- **4xx errors** - Client mistakes (don't retry)
- **5xx errors** - Server errors (can retry)

**Error Handling:**

- Always handle errors
- Provide user-friendly messages
- Log errors for debugging
- Retry transient errors (5xx, network)

**Best Practices:**

- Use consistent error format
- Include error details
- Handle all status codes
- Implement retry strategies for transient errors
