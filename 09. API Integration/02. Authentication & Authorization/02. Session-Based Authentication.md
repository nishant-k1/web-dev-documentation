# Session-Based Authentication

Understanding session-based (cookie-based) authentication - how it works, why it's stateful, and the complete workflow.

---

## Core Concept

**Session-Based Authentication** stores user session data on the server and uses cookies to track sessions.

**Key Characteristics:**

- ✅ **Stateful** - Server stores session data
- ✅ **Cookie-based** - Uses HTTP cookies
- ✅ **Server-side storage** - Session data on server
- ✅ **Session ID** - Cookie contains only session ID

---

## Session Structure

### What is a Session?

**Session** is server-side storage that contains:

- User ID
- User role/permissions
- Login timestamp
- Session expiration
- Any other user data

**Session ID** is a unique identifier (random string) that points to this session data.

---

### Cookie Content

**Cookie contains:**

- Only the session ID (random string)
- No user data
- No credentials

**Example Cookie:**

```sql
sessionId=abc123def456ghi789
```

**Session Data (on server):**

```javascript
{
  sessionId: 'abc123def456ghi789',
  userId: 123,
  role: 'admin',
  loginTime: '2024-01-01T00:00:00Z',
  expiresAt: '2024-01-02T00:00:00Z'
}
```

---

## Complete Session Workflow

### Step 1: User Login

**Frontend sends credentials:**

```javascript
fetch("/api/login", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
  },
  body: JSON.stringify({
    email: "user@example.com",
    password: "password123",
  }),
  credentials: "include", // Important for cookies
});
```

**Backend verifies and creates session:**

```javascript
// Backend (Express.js example)
const session = require("express-session");

app.use(
  session({
    secret: "your-secret-key",
    resave: false,
    saveUninitialized: false,
    cookie: {
      secure: true, // HTTPS only
      httpOnly: true, // Not accessible via JavaScript
      maxAge: 24 * 60 * 60 * 1000, // 24 hours
    },
  })
);

app.post("/api/login", async (req, res) => {
  const { email, password } = req.body;

  // 1. Find user in database
  const user = await User.findOne({ email });

  // 2. Verify password
  const isValid = await bcrypt.compare(password, user.password);

  if (!isValid) {
    return res.status(401).json({ error: "Invalid credentials" });
  }

  // 3. Create session (stores on server)
  req.session.userId = user.id;
  req.session.role = user.role;
  req.session.email = user.email;

  // 4. Cookie with session ID sent automatically
  res.json({ message: "Login successful" });
});
```

---

### Step 2: Cookie Sent Automatically

**Browser automatically:**

- Receives `Set-Cookie` header from server
- Stores cookie
- Sends cookie with every request to same domain

**No frontend code needed** - browser handles it automatically.

---

### Step 3: Subsequent Requests

**Frontend makes request:**

```javascript
// Cookie sent automatically by browser
fetch("/api/users", {
  credentials: "include", // Include cookies
});
```

**Backend verifies session:**

```javascript
// Middleware to check session
function requireAuth(req, res, next) {
  if (!req.session.userId) {
    return res.status(401).json({ error: 'Not authenticated' });
  }

  // Session exists - user is authenticated
  req.user = {
    id: req.session.userId,
    role: req.session.role,
    email: req.session.email
  };

  next();
}

// Use middleware
app.get('/api/users', requireAuth, (req, res) => {
  // req.user contains session data
  res.json({ users: [...] });
});
```

---

## Why Session is Stateful

### Server Stores Session Data

**What server stores:**

- ✅ **Session data** - User ID, role, etc. (in memory/database)
- ✅ **Session ID** - Maps to session data

**What client stores:**

- ✅ **Cookie** - Only session ID (no user data)

---

### Stateful Explanation

**Session-Based (Stateful):**

```sql
User Login → Server creates session → Stores session data on server
Cookie sent → Contains session ID only
Next Request → Server receives session ID → Looks up session data → Finds user info
```

**Key Point:** Server must **look up** session data for each request.

---

## Session Storage

### Where Sessions Are Stored

**Options:**

1. **Memory (default)**

   - Stored in server RAM
   - Lost on server restart
   - Not scalable (multiple servers)

2. **Database**

   - Stored in database (Redis, MongoDB, PostgreSQL)
   - Persists across restarts
   - Scalable (shared across servers)

3. **Redis (common)**
   - Fast in-memory database
   - Persists data
   - Scalable

---

### Example: Redis Session Store

```javascript
const RedisStore = require("connect-redis")(session);
const redis = require("redis");

const client = redis.createClient();

app.use(
  session({
    store: new RedisStore({ client }),
    secret: "your-secret-key",
    resave: false,
    saveUninitialized: false,
    cookie: {
      httpOnly: true,
      secure: true,
      maxAge: 24 * 60 * 60 * 1000,
    },
  })
);
```

---

## Session vs JWT Comparison

### Detailed Comparison

| Aspect             | Session-Based                  | JWT                               |
| ------------------ | ------------------------------ | --------------------------------- |
| **State**          | Stateful                       | Stateless                         |
| **User Data**      | Stored on server               | In token (client)                 |
| **Cookie/Token**   | Session ID only                | User data + signature             |
| **Server Storage** | Session data (per user)        | Secret key (one for all)          |
| **Verification**   | Lookup session ID              | Verify signature                  |
| **Scalability**    | Requires shared storage        | Better (no storage)               |
| **Logout**         | Delete session                 | Token valid until expiry          |
| **Security**       | HttpOnly cookies (more secure) | Stored in localStorage (XSS risk) |

---

### Workflow Comparison

**Session-Based:**

```sql
1. Login → Server creates session → Stores { userId: 123, role: 'admin' }
2. Cookie sent → Contains sessionId: 'abc123'
3. Request → Server receives sessionId → Looks up session → Finds { userId: 123, role: 'admin' }
```

**JWT:**

```sql
1. Login → Server creates token → Token contains { userId: 123, role: 'admin' }
2. Token sent → Contains encoded user data
3. Request → Server receives token → Verifies signature → Extracts { userId: 123, role: 'admin' }
```

---

## Complete Example

### Frontend (React)

```javascript
// Login
async function login(email, password) {
  const res = await fetch("/api/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, password }),
    credentials: "include", // Important!
  });

  // Cookie stored automatically by browser
  if (res.ok) {
    console.log("Logged in");
  }
}

// Protected Request
async function fetchUsers() {
  const res = await fetch("/api/users", {
    credentials: "include", // Send cookie automatically
  });

  if (res.status === 401) {
    // Not authenticated - redirect to login
    window.location.href = "/login";
    return;
  }

  return await res.json();
}

// Logout
async function logout() {
  await fetch("/api/logout", {
    method: "POST",
    credentials: "include",
  });
  // Cookie cleared by server
}
```

### Backend (Express.js)

```javascript
const session = require('express-session');

app.use(session({
  secret: process.env.SESSION_SECRET,
  resave: false,
  saveUninitialized: false,
  cookie: {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    maxAge: 24 * 60 * 60 * 1000
  }
}));

// Login
app.post('/api/login', async (req, res) => {
  const { email, password } = req.body;

  const user = await User.findOne({ email });
  if (!user || !await bcrypt.compare(password, user.password)) {
    return res.status(401).json({ error: 'Invalid credentials' });
  }

  // Create session
  req.session.userId = user.id;
  req.session.role = user.role;

  res.json({ message: 'Login successful' });
});

// Protected route
app.get('/api/users', (req, res) => {
  if (!req.session.userId) {
    return res.status(401).json({ error: 'Not authenticated' });
  }

  res.json({ users: [...] });
});

// Logout
app.post('/api/logout', (req, res) => {
  req.session.destroy((err) => {
    if (err) {
      return res.status(500).json({ error: 'Logout failed' });
    }
    res.clearCookie('connect.sid');
    res.json({ message: 'Logged out' });
  });
});
```

---

## Common Questions

### Q: What's in the cookie?

**A:** Only the session ID (random string). No user data, no credentials.

### Q: Where is session data stored?

**A:** On the server - in memory, database, or Redis. Not in the cookie.

### Q: Why is session stateful?

**A:** Because server stores user session data and must look it up for each request.

### Q: Can I see session data in cookie?

**A:** No. Cookie only contains session ID. Session data is on server.

### Q: What happens on server restart?

**A:** Depends on storage:

- **Memory:** Sessions lost
- **Database/Redis:** Sessions persist

---

## Related Topics

- [JWT Authentication](./01.%20JWT%20Authentication%20Workflow.md) - Alternative to sessions
- [Authentication vs Authorization](./index.md) - Concepts
- [HTTP Authentication](../01.%20HTTP/08.%20Authentication.md) - HTTP-level auth
- [Protected Routes](./04.%20Protected%20Routes.md) - Route protection

---

## Summary

**Session Workflow:**

1. User logs in with credentials
2. Server verifies credentials
3. Server creates session (stores user data)
4. Server sends cookie with session ID
5. Browser stores cookie automatically
6. Browser sends cookie with each request
7. Server receives session ID
8. Server looks up session data
9. Server uses session data for authentication

**Key Points:**

- Session is stateful (server stores user data)
- Cookie contains only session ID
- Server must look up session for each request
- Browser handles cookies automatically
- Session data stored in memory/database/Redis

**Why Stateful:**

- Server stores per-user session data
- Server must look up session for each request
- Cookie is just a pointer (session ID)
- Requires shared storage for scalability
