# React Fiber and Concurrent React

## TL;DR

- **React Fiber** = Reconciliation engine rewrite (React 16+): work in units, interruptible, prioritization.
- **Concurrent Rendering** = React 18+: pause, resume, prioritize; keep UI responsive during heavy updates.
- **Features:** `useTransition`, `useDeferredValue`, Suspense, `startTransition`, automatic batching, time slicing.

---

## 1. React Fiber as the Reconciliation Engine

React Fiber is the **reconciliation engine** that:

1. Optimizes rendering updates.
2. Breaks work into **small units** that can be paused and resumed.
3. Enables **prioritization** (e.g. user input over background updates).

It introduces the **Fiber tree**: a tree of nodes that tracks component hierarchy, updates, and side effects.

### Why Fiber

Before Fiber, React used a **stack-based, synchronous** reconciler:

- Long renders **blocked** the main thread.
- No pause/resume, no prioritization → jank and unresponsive UI.

Fiber’s goals:

- **Interruptible rendering** — work can be paused, chunked, resumed.
- **Prioritization** — high-priority updates (e.g. input, clicks) first.
- **Concurrency** — foundation for Concurrent Mode, Suspense, time slicing.

---

## 2. How Fiber Works

### Fiber as a Data Structure

Each component/element has a **Fiber node** (a unit of work):

```javascript
{
  type: 'div',
  key: null,
  stateNode: DOMNode,
  child: FiberNode,
  sibling: FiberNode,
  return: FiberNode,
  alternate: FiberNode,     // for diffing
  effectTag: 'UPDATE',      // PLACEMENT, UPDATE, DELETION
  pendingProps: {...},
  memoizedProps: {...},
  memoizedState: {...},
  updateQueue: [...],
}
```

### Fiber Tree

The tree mirrors your component tree (child / sibling / return). React traverses it to do work in small steps and can pause between nodes.

### Two Phases

| Render Phase (interruptible) | Commit Phase (synchronous) |
| ---------------------------- | -------------------------- |
| Build Fiber tree, diff, mark | Apply changes to DOM, run effects |
| Can pause / discard           | Must run to completion     |

![alt text](image-1.png)
![alt text](image.png)

---

## 3. Key Concepts

- **Work units** — Updates are split into small units; React does as much as fits in a frame (~16ms), then yields.
- **Priority levels** — From Immediate (e.g. input) to Idle (e.g. offscreen). High-priority work can interrupt low-priority.
- **Scheduling** — React decides when to pause, what to do next, and how to respect deadlines.

---

## 4. Concurrent Rendering (React 18+)

Concurrent rendering lets React work on multiple versions of the UI and **interrupt** low-priority work for urgent updates.

**Enable with the new root API:**

```jsx
import { createRoot } from "react-dom/client";
const root = createRoot(document.getElementById("root"));
root.render(<App />);
```

Legacy `ReactDOM.render()` does not use concurrent features.

### Priority Levels (conceptual)

| Priority        | Example           | Interruptible? |
| --------------- | ----------------- | -------------- |
| Immediate       | Input, click      | No             |
| User-blocking   | Hover, focus      | Rarely         |
| Normal          | Network response  | Yes            |
| Low / Idle      | Analytics, offscreen | Yes         |

### Concurrent Features (short)

- **startTransition / useTransition** — Mark non-urgent state updates so React can interrupt them.
- **useDeferredValue** — Defer a value’s update (e.g. keep typing snappy while list filters in background).
- **Suspense** — Show fallback while async work (data, lazy component) is pending; React can interrupt and prioritize.

### Automatic Batching (React 18)

State updates are batched in **all** contexts (event handlers, timeouts, promises), not only in React events. One re-render for multiple updates. Use `flushSync` only when you must opt out (rare).

### Time Slicing

Rendering is split into small chunks; React yields to the browser between chunks so input and animation stay responsive instead of one long blocking render.

---

## 5. Benefits and Takeaways

- Smoother UI: high-priority work first, no long freezes.
- Fiber enables Concurrent Mode, Suspense, and better perceived performance.
- Breaking work into units and separating render vs commit is what makes this possible.

Fiber is the backbone of React’s modern architecture; concurrent features in React 18+ build on it.
