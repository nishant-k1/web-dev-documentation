# Diffing

Diffing is the comparison step during reconciliation. It works **between two in-memory trees** (e.g. current Fiber tree vs work-in-progress Fiber tree). React never diffs against the real DOM.
It always happens between two in-memory trees.

.

ðŸ”¹ Important Rule

React never diffs against the real DOM.

The real DOM is only updated during commit.

Diffing happens before any real DOM mutation.

ðŸ”¹ What Actually Happens (Modern Fiber Model)

```text
Build work-in-progress Fiber tree
    â†“
Compare with current Fiber tree
    â†“
Mark updates
    â†“
Commit DOM mutations
```

**Step 1 â€” Build Work-In-Progress Tree**

React runs your component again and builds a new tree in memory.
This is not mutating the old tree.
It creates a separate "work-in-progress" tree.

**Step 2 â€” Compare With Current Tree**

While building the new tree, React compares:
Element types
Keys
Props
Children structure

This is the diffing algorithm.

This process is called reconciliation.
Still no real DOM touched.

**Step 3 â€” Mark Updates**
If React sees a difference, it marks the Fiber node with flags like:
Placement
Update
Deletion

These flags are stored on Fiber nodes.

**Step 4 â€” Commit Phase**

Now React walks the marked fibers and:
Inserts DOM nodes
Updates attributes
Removes nodes

Only here does real DOM change.

ðŸ”¹ Old Mental Model vs Accurate Mental Model
Old simplified explanation:
`New vDOM â†’ diff â†’ patch DOM`

More precise version:

Current Fiber tree (represents UI on screen)
Work-in-progress Fiber tree (represents next UI)
Diff happens between those two
DOM mutations happen after diff is complete

ðŸ”¹ Key Clarification
The real DOM is never used for comparison.
React trusts its Fiber tree as the source of truth.
Real DOM is treated as a dumb output target.

## Diffing algo works between old vDOM and new vDOM after mutation?

No mutation yet.
The new tree is built separately.

Does it compare with real DOM? No. Never.

Comparison is always:
Current Fiber tree â†” Work-in-progress Fiber tree

```text
Render Phase:
  - Build new Fiber tree
  - Compare with current Fiber tree
  - Mark differences

Commit Phase:
  - Apply differences to real DOM
```

---

## Keys and Reconciliation

**Keys** help React identify which items in a list are the same, added, removed, or reordered across renders.

- **Why keys matter:** Without keys, React relies on **position** (index). If you insert, remove, or reorder list items, React can reuse the wrong DOM nodes and mix up state (e.g. which item is selected). With a **stable, unique key** per item (e.g. `item.id`), React can match old and new items correctly and only update what changed.
- **Where keys are used:** During diffing, when React compares children of a list, it uses the `key` prop to decide whether to reuse an existing Fiber/DOM node, update it, or remove/create it. Wrong or missing keys can cause unnecessary re-renders, wrong UI, or bugs.
- **Good keys:** Stable unique IDs from your data. **Avoid index as key** when the list can be reordered, filtered, or items added/removed in the middle.

So: keys directly affect how the diffing algorithm reconciles list children and updates the real DOM.
